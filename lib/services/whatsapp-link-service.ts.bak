import { prisma } from '@/lib/config/prisma'
import { NotificationType } from '@prisma/client'
import { generateId } from '@/lib/utils/generate-id'

export interface WhatsAppLinkOptions {
  clubId: string
  notificationType: NotificationType
  playerName: string
  playerPhone?: string
  bookingId?: string
  bookingGroupId?: string
  message?: string
  expirationHours?: number // Optional expiration (default: 24 hours)
}

export interface WhatsAppLinkResult {
  success: boolean
  notificationId?: string
  whatsappLink?: string
  message?: string
  error?: string
}

/**
 * WhatsApp Link Service
 * Generates wa.me links for direct WhatsApp messaging without Business API
 */
export class WhatsAppLinkService {
  
  /**
   * Generate WhatsApp link with notification tracking
   */
  static async generateLink(options: WhatsAppLinkOptions): Promise<WhatsAppLinkResult> {
    try {
      // Get club information
      const club = await prisma.Club.findUnique({
        where: { id: options.clubId },
        select: {
          id: true,
          name: true,
          whatsappNumber: true,
          phone: true
        }
      })

      if (!club) {
        return {
          success: false,
          error: 'Club no encontrado'
        }
      }

      // Use WhatsApp number or fallback to regular phone
      const clubPhone = club.whatsappNumber || club.phone
      if (!clubPhone) {
        return {
          success: false,
          error: 'N√∫mero de WhatsApp no configurado para el club'
        }
      }

      // Generate message content based on notification type
      const message = options.message || this.generateMessageFromClub(options, club.name)
      
      // Create wa.me link with CLIENT phone as destination
      const encodedMessage = encodeURIComponent(message)
      // Use player phone if provided, otherwise we can't create the link
      if (!options.playerPhone) {
        return {
          success: false,
          error: 'N√∫mero de tel√©fono del cliente requerido'
        }
      }
      const cleanPhone = this.formatPhoneForWhatsApp(options.playerPhone)
      const whatsappLink = `https://wa.me/${cleanPhone}?text=${encodedMessage}`

      // Calculate expiration date
      const expirationHours = options.expirationHours || 24
      const linkExpiredAt = new Date()
      linkExpiredAt.setHours(linkExpiredAt.getHours() + expirationHours)

      // Create notification record with WhatsApp link tracking
      const notification = await prisma.notification.create({
        data: {
          id: generateId(),
          clubId: options.clubId,
          type: options.notificationType,
          recipient: options.playerName,
          recipientPhone: options.playerPhone,
          status: 'link_generated',
          
          // Content
          title: this.getNotificationTitle(options.notificationType),
          message,
          
          // WhatsApp specific fields
          whatsappLink,
          linkClicked: false,
          linkExpiredAt,
          clubPhone,
          
          // Relations
          bookingId: options.bookingId,
          bookingGroupId: options.bookingGroupId
        }
      })

      return {
        success: true,
        notificationId: notification.id,
        whatsappLink,
        message
      }

    } catch (error) {
      console.error('Error generating WhatsApp link:', error)
      return {
        success: false,
        error: 'Error generando link de WhatsApp'
      }
    }
  }

  /**
   * Track link click
   */
  static async trackLinkClick(notificationId: string): Promise<boolean> {
    try {
      await prisma.notification.update({
        where: { id: notificationId },
        data: {
          linkClicked: true,
          clickedAt: new Date(),
          status: 'delivered' // Consider it delivered when clicked
        }
      })
      return true
    } catch (error) {
      console.error('Error tracking link click:', error)
      return false
    }
  }

  /**
   * Check and mark expired links
   */
  static async markExpiredLinks(): Promise<number> {
    try {
      const now = new Date()
      const result = await prisma.notification.updateMany({
        where: {
          linkExpiredAt: {
            lte: now
          },
          linkClicked: false,
          status: {
            in: ['link_generated', 'pending']
          }
        },
        data: {
          status: 'expired'
        }
      })
      
      return result.count
    } catch (error) {
      console.error('Error marking expired links:', error)
      return 0
    }
  }

  /**
   * Get notification statistics for a club
   */
  static async getNotificationStats(clubId: string, days: number = 7) {
    try {
      const since = new Date()
      since.setDate(since.getDate() - days)

      const stats = await prisma.notification.groupBy({
        by: ['status'],
        where: {
          clubId,
          createdAt: {
            gte: since
          },
          whatsappLink: {
            not: null
          }
        },
        _count: {
          status: true
        }
      })

      return stats.reduce((acc, stat) => {
        acc[stat.status] = stat._count.status
        return acc
      }, {} as Record<string, number>)

    } catch (error) {
      console.error('Error getting notification stats:', error)
      return {}
    }
  }

  /**
   * Generate message content from club to client perspective
   */
  private static generateMessageFromClub(options: WhatsAppLinkOptions, clubName: string): string {
    const { notificationType, playerName, bookingId } = options
    const paymentUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://padelyzer.com'

    const messages = {
      BOOKING_CONFIRMATION: 
        `¬°Hola ${playerName}! üëã\n\n` +
        `Tu reserva en ${clubName} ha sido confirmada ‚úÖ\n\n` +
        `¬°Te esperamos en la cancha! üéæ\n\n` +
        (bookingId ? `üí≥ Puedes pagar tu reserva en l√≠nea:\n${paymentUrl}/pay/${bookingId}` : ''),

      PAYMENT_REMINDER:
        `¬°Hola ${playerName}! üí∞\n\n` +
        `Te recordamos que tienes un pago pendiente para tu reserva en ${clubName}.\n\n` +
        (bookingId ? `üí≥ Puedes pagar en l√≠nea:\n${paymentUrl}/pay/${bookingId}\n\n` : '') +
        `Por favor, completa el pago lo antes posible para confirmar tu reserva üéæ`,

      BOOKING_CANCELLATION:
        `¬°Hola ${playerName}! ‚ùå\n\n` +
        `Tu reserva en ${clubName} ha sido cancelada.\n\n` +
        `Si tienes alguna duda, no dudes en contactarnos üìû`,

      SPLIT_PAYMENT_REQUEST:
        `¬°Hola ${playerName}! üí∏\n\n` +
        `Te han invitado a dividir el pago de una reserva en ${clubName}.\n\n` +
        (bookingId ? `üí≥ Puedes pagar tu parte en l√≠nea:\n${paymentUrl}/pay/${bookingId}\n\n` : '') +
        `Por favor, completa tu parte del pago para confirmar tu participaci√≥n üéæ`,

      SPLIT_PAYMENT_COMPLETED:
        `¬°Hola ${playerName}! ‚úÖ\n\n` +
        `El pago dividido para tu reserva en ${clubName} ha sido completado.\n\n` +
        `¬°Nos vemos en la cancha! üéæ`,

      GENERAL:
        `¬°Hola ${playerName}! üëã\n\n` +
        `${clubName} tiene una notificaci√≥n para ti.\n\n` +
        `¬°Gracias por elegirnos! üéæ`
    }

    return messages[notificationType] || messages.GENERAL
  }

  /**
   * Get notification title based on type
   */
  private static getNotificationTitle(type: NotificationType): string {
    const titles = {
      BOOKING_CONFIRMATION: 'Reserva Confirmada',
      PAYMENT_REMINDER: 'Recordatorio de Pago',
      BOOKING_CANCELLATION: 'Reserva Cancelada',
      SPLIT_PAYMENT_REQUEST: 'Solicitud de Pago Dividido',
      SPLIT_PAYMENT_COMPLETED: 'Pago Dividido Completado',
      GENERAL: 'Notificaci√≥n'
    }

    return titles[type] || titles.GENERAL
  }

  /**
   * Validate phone number format
   */
  static validatePhoneNumber(phone: string): boolean {
    // Mexican phone number validation
    // Accepts: +52XXXXXXXXXX, 52XXXXXXXXXX, or 10 digits
    const cleanPhone = phone.replace(/[^\d]/g, '')
    
    if (cleanPhone.length === 10) return true // Local format
    if (cleanPhone.length === 12 && cleanPhone.startsWith('52')) return true // With country code
    if (cleanPhone.length === 13 && cleanPhone.startsWith('521')) return true // With mobile prefix
    
    return false
  }

  /**
   * Format phone number for wa.me links
   */
  static formatPhoneForWhatsApp(phone: string): string {
    const cleanPhone = phone.replace(/[^\d]/g, '')
    
    // If it's 10 digits, add Mexico country code
    if (cleanPhone.length === 10) {
      return `52${cleanPhone}`
    }
    
    // If it already has country code, use as is
    if (cleanPhone.length === 12 && cleanPhone.startsWith('52')) {
      return cleanPhone
    }
    
    // If it has mobile prefix (521), use as is  
    if (cleanPhone.length === 13 && cleanPhone.startsWith('521')) {
      return cleanPhone
    }
    
    return cleanPhone // Return as is for other formats
  }

  /**
   * Send booking confirmation via WhatsApp link
   */
  static async sendBookingConfirmation(bookingId: string): Promise<WhatsAppLinkResult> {
    try {
      const booking = await prisma.Booking.findUnique({
        where: { id: bookingId },
        include: {
          club: { select: { id: true, name: true } },
          court: { select: { name: true } }
        }
      })

      if (!booking) {
        return { success: false, error: 'Reserva no encontrada' }
      }

      const paymentUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://padelyzer.com'
      const customMessage = 
        `¬°Hola ${booking.playerName}! üëã\n\n` +
        `Tu reserva en ${booking.Club.name} ha sido confirmada:\n\n` +
        `‚Ä¢ Fecha: ${booking.date.toLocaleDateString('es-MX')}\n` +
        `‚Ä¢ Hora: ${booking.startTime}\n` +
        `‚Ä¢ Cancha: ${booking.Court.name}\n` +
        `‚Ä¢ Total: $${(booking.price / 100).toFixed(2)} MXN\n\n` +
        `üí≥ Puedes pagar tu reserva en l√≠nea:\n${paymentUrl}/pay/${booking.id}\n\n` +
        `¬°Te esperamos! üéæ`

      return await this.generateLink({
        clubId: booking.clubId,
        notificationType: 'BOOKING_CONFIRMATION',
        playerName: booking.playerName,
        playerPhone: booking.playerPhone,
        bookingId: booking.id,
        message: customMessage
      })

    } catch (error) {
      console.error('Error sending booking confirmation:', error)
      return { success: false, error: 'Error enviando confirmaci√≥n' }
    }
  }

  /**
   * Send split payment request via WhatsApp link
   */
  static async sendSplitPaymentRequest(splitPaymentId: string): Promise<WhatsAppLinkResult> {
    try {
      const splitPayment = await prisma.splitPayment.findUnique({
        where: { id: splitPaymentId },
        include: {
          Booking: {
            include: {
              Club: { select: { id: true, name: true } },
              Court: { select: { name: true } }
            }
          }
        }
      })

      if (!splitPayment || !splitPayment.booking) {
        return { success: false, error: 'Pago dividido no encontrado' }
      }

      const paymentUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://padelyzer.com'
      const paymentLink = `${paymentUrl}/pay/${splitPayment.Booking.id}?split=${splitPayment.id}`
      
      const customMessage = 
        `¬°Hola ${splitPayment.playerName}! üí∏\n\n` +
        `Te han invitado a dividir el pago de una reserva:\n\n` +
        `‚Ä¢ Club: ${splitPayment.Booking.Club.name}\n` +
        `‚Ä¢ Fecha: ${splitPayment.Booking.date.toLocaleDateString('es-MX')}\n` +
        `‚Ä¢ Hora: ${splitPayment.Booking.startTime}\n` +
        `‚Ä¢ Cancha: ${splitPayment.Booking.Court.name}\n` +
        `‚Ä¢ Tu parte: $${(splitPayment.amount / 100).toFixed(2)} MXN\n\n` +
        `üí≥ Puedes pagar tu parte en l√≠nea:\n${paymentLink}\n\n` +
        `¬°Nos vemos en la cancha! üéæ`

      return await this.generateLink({
        clubId: splitPayment.Booking.clubId,
        notificationType: 'SPLIT_PAYMENT_REQUEST',
        playerName: splitPayment.playerName,
        playerPhone: splitPayment.playerPhone,
        bookingId: splitPayment.bookingId,
        message: customMessage
      })

    } catch (error) {
      console.error('Error sending split payment request:', error)
      return { success: false, error: 'Error enviando solicitud de pago' }
    }
  }
}

export default WhatsAppLinkService